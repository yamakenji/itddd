# Chapter5 リポジトリ

リポジトリは永続化や再構築を担う。

* 永続化（保存）や再構築（復元）といったデータストアを操作する処理を切り離し、抽象的に扱えるようにして処理の意図を明確にする。
* データストアの差し替えを可能にする
  * テスト実行を容易にする
  * 変更の難易度を下げる

## 5.1 リポジトリとは

* 保管庫 -> データの保管庫
* リポジトリはデータを永続化し再構築するといった処理を抽象的に行うためのオブジェクト
* データの永続化と再構築を直接行うのではなく、リポジトリを経由して行う -> ソフトウェアに柔軟性を与える

## 5.2 リポジトリの責務

* リポジトリの責務はドメインオブジェクトの永続化（保存）や再構築（復元）を行うこと
* 永続化の先はRDB、ファイル、NoSQL DBなど様々
* 永続化を実施するために記述される特定のデータストアに基づく具体的な手順はややこしい
  * _01/Program.cs
  * _01/UserService.cs
  * コードの大半がデータストアに対する具体的な操作
* ユーザ作成処理をリポジトリを利用した実装に置き換えると
  * _03/Program.cs
  * User オブジェクトの永続化をリポジトリであるIUserRepository オブジェクトに依頼する
    -> データストアに対する命令を抽象的に行うことで、ユーザ作成処理として純粋なロジックになった
* 重複チェック処理を行うドメインサービスの実装
  * _03/UserService.cs
  * コードの意図が明確になった
  
## 5.3 リポジトリのインターフェース

* リポジトリの責務はオブジェクトの永続化
  * User クラスのリポジトリインターフェースには、オブジェクトの永続化以外の処理はいれない
    * _07/IUserRepository.cs
  * ユーザの重複確認はドメインのルールに近いので、ドメインサービスが主体となるべき
    * _07/UserService.cs
  * 仮にリポジトリに重複確認を定義する場合は、ユーザ名で重複確認を行うという知識を表現するため、ユーザ名を引き渡すとよい
    * _08/IUserRepository.cs

## 5.4 SQL を利用したリポジトリを作成する

* リポジトリの実装には特定の技術基盤に依存した処理を記述する
* Program クラスでIUserRepository インターフェースを扱い、その実体である UserRepository クラスの処理を呼び出す
  * _12/Program.cs

## 5.5 テストによる確認


## 5.6 テスト用のリポジトリを作成する

## 5.7 オブジェクトリレーショナルマッパーを用いたリポジトリを作成する

## 5.8 リポジトリに定義されたふるまい

## 5.9 まとめ